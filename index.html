<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Anchor Homes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: sans-serif;
      background: #050505;
      color: #d3d3d3;
    }
    .card {
      background: #151515;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .card-title {
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }
    .field-group {
      margin-bottom: 1rem;
    }
    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
      color: #bbb;
    }
    input, textarea {
      width: 100%;
      padding: 0.6rem;
      border-radius: 8px;
      border: 1px solid #333;
      background: #101010;
      color: #fff;
    }
    .signature-pad {
      border: 1px dashed #666;
      background: #111;
      margin-top: 0.5rem;
    }
    canvas {
      width: 100%;
      height: 150px;
    }
    button {
      padding: 0.6rem 1.2rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }
    .btn-primary {
      background: #fff;
      color: #000;
    }
    .btn-outline {
      background: transparent;
      border: 1px solid #fff;
      color: #fff;
    }
    .pdf-preview {
      margin-top: 1rem;
      border: 1px solid #333;
    }
  </style>
</head>
<body>
  <div class="content">
    <section id="new-subcontractors" class="card">
      <h1 class="card-title">New Subcontractors</h1>
      <p>Complete the Subcontractor Agreement and W‑9, sign, and upload your Certificate of Insurance.</p>

      <form id="new-subcontractor-form">
        <!-- Basic Info -->
        <div class="field-group">
          <label for="ns-name">Subcontractor Name</label>
          <input type="text" id="ns-name" name="ns_name" required />
        </div>
        <div class="field-group">
          <label for="ns-email">Email</label>
          <input type="email" id="ns-email" name="ns_email" required />
        </div>

        <!-- Signature Pads -->
        <div class="field-group">
          <label>Agreement Signature</label>
          <div class="signature-pad"><canvas id="sig-agreement"></canvas></div>
        </div>
        <div class="field-group">
          <label>W‑9 Signature</label>
          <div class="signature-pad"><canvas id="sig-w9"></canvas></div>
        </div>

        <!-- Certificate of Insurance -->
        <div class="field-group">
          <label for="ns-coi">Upload Certificate of Insurance</label>
          <input type="file" id="ns-coi" name="ns_coi_file" required />
        </div>

        <div class="button-row">
          <button type="submit" class="btn-primary">Submit Packet</button>
          <button type="reset" class="btn-outline">Clear</button>
        </div>
      </form>

      <!-- PDF Previews -->
      <h2 class="card-title" style="margin-top:2rem;">Agreement Preview</h2>
      <canvas id="agreement-preview" class="pdf-preview"></canvas>

      <h2 class="card-title" style="margin-top:2rem;">W‑9 Preview</h2>
      <canvas id="w9-preview" class="pdf-preview"></canvas>
    </section>
  </div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad"></script>

  <script>
    // Render PDFs with PDF.js
    function renderPDF(url, canvasId) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      pdfjsLib.getDocument(url).promise.then(pdf => {
        pdf.getPage(1).then(page => {
          const viewport = page.getViewport({ scale: 1 });
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          page.render({ canvasContext: ctx, viewport: viewport });
        });
      });
    }
    renderPDF('subagreement.pdf', 'agreement-preview');
    renderPDF('w9.pdf', 'w9-preview');

    // Signature Pads
    const sigAgreementPad = new SignaturePad(document.getElementById('sig-agreement'));
    const sigW9Pad = new SignaturePad(document.getElementById('sig-w9'));

    // Handle form submit
    document.getElementById('new-subcontractor-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      // Load PDFs
      const agreementBytes = await fetch('subagreement.pdf').then(res => res.arrayBuffer());
      const w9Bytes = await fetch('w9.pdf').then(res => res.arrayBuffer());

      const agreementDoc = await PDFLib.PDFDocument.load(agreementBytes);
      const w9Doc = await PDFLib.PDFDocument.load(w9Bytes);

      const agreementPage = agreementDoc.getPages()[agreementDoc.getPageCount()-1];
      const w9Page = w9Doc.getPages()[0];

      // Draw text fields
      const subcontractorName = document.getElementById('ns-name').value;
      agreementPage.drawText(subcontractorName, { x: 100, y: 100, size: 12 });
      w9Page.drawText(subcontractorName, { x: 100, y: 700, size: 12 });

      // Embed signatures
      async function embedSignature(doc, page, pad, x, y) {
        if (!pad.isEmpty()) {
          const sigDataUrl = pad.toDataURL();
          const pngBytes = await fetch(sigDataUrl).then(res => res.arrayBuffer());
          const pngImage = await doc.embedPng(pngBytes);
          page.drawImage(pngImage, { x, y, width: 200, height: 80 });
        }
      }
      await embedSignature(agreementDoc, agreementPage, sigAgreementPad, 100, 50);
      await embedSignature(w9Doc, w9Page, sigW9Pad, 100, 100);

      // Save PDFs
      const agreementOut = await agreementDoc.save();
      const w9Out = await w9Doc.save();

      // Build FormData for Formspree
      const formData = new FormData();
      formData.append("signed_agreement", new File([agreementOut], "signed-agreement.pdf", { type: "application/pdf" }));
      formData.append("signed_w9", new File([w9Out], "signed-w9.pdf", { type: "application/pdf" }));
      formData.append("ns_name", subcontractorName);
      formData.append("ns_email", document.getElementById('ns-email').value);
      formData.append("ns_coi_file", document.getElementById('ns-coi').files[0]);

      // Send to Formspree
      await fetch("https://formspree.io/f/YOUR_NEW_SUBCONTRACTOR_FORM_ID", {
        method: "POST",
        body: formData
      });

      alert("Submitted successfully!");
    });
  </script>
</body>
</html>
